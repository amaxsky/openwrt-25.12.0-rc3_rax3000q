name: Build RAX3000Q (32bit)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # 1. 缓存 dl/（下载包缓存）
    # -----------------------------
    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: dl
        key: dl-cache

    # -----------------------------
    # 2. 缓存 ccache（编译缓存）
    # -----------------------------
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}
        restore-keys: ccache-

    # -----------------------------
    # 3. 缓存 host tools（大幅减少 host 构建时间）
    # -----------------------------
    - name: Cache host tools
      uses: actions/cache@v4
      with:
        path: build_dir/host
        key: host-tools

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync unzip zlib1g-dev file wget ccache

    # 启用 ccache
    - name: Enable ccache
      run: |
        echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV
        echo 'export CC="ccache gcc"' >> $GITHUB_ENV
        echo 'export CXX="ccache g++"' >> $GITHUB_ENV

    - name: Fix permissions
      run: chmod -R +x .

    - name: Update & install feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # -----------------------------
    # 生成 32 位 RAX3000Q 配置
    # -----------------------------
    - name: Generate config for RAX3000Q (32-bit)
      run: |
        rm -f .config
        echo "CONFIG_TARGET_qualcommax=y" >> .config
        echo "CONFIG_TARGET_qualcommax_ipq50xx=y" >> .config
        echo "CONFIG_TARGET_qualcommax_ipq50xx_DEVICE_cmcc_rax3000q=y" >> .config

        # 强制 32 位
        echo "CONFIG_ARCH_32=y" >> .config
        echo "CONFIG_ARM=y" >> .config

        # 防止 defconfig 自动切回 64 位
        echo "# CONFIG_ARM64 is not set" >> .config
        echo "# CONFIG_64BIT is not set" >> .config

        make defconfig

    - name: Build firmware
      run: |
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: rax3000q-firmware-32bit
        path: bin/targets/
